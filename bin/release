#!/usr/bin/env ruby
require 'psych'

Dir.chdir ARGV.first
config = Psych.load_file('sidekiq-workers.yml').to_hash

command_template = config[:command_template] || "bundle exec %s"
sidekiq_command  = config[:sidekiq_template] || "sidekiq -e $RACK_ENV -q %s"
queue_string     = proc {|queue, weight| "#{queue},#{weight}"}

proctypes = config[:dynos].map {|dyno, queues| {dyno.to_s => command_template % (sidekiq_command % (queues.map(&queue_string).join(' ')))}}.inject(:merge)

result = { "default_process_types" => proctypes }

puts result.to_yaml
